pkgname=wine-d3dstream
pkgver=1.7.1
pkgrel=1
_pkgname=wine
_pkgrc=
_pkgbasever=${pkgver}${_pkgrc}
source=(
        http://prdownloads.sourceforge.net/$_pkgname/$_pkgname-$_pkgbasever.tar.bz2
)
md5sums=(
        '3a3fae3e541ccaf1b891d89b5594ecc5'
)
pkgdesc="Wine with D3D command stream patches"
url="http://www.winehq.com"
arch=(i686 x86_64)
license=(LGPL)
install=wine.install
depends=(
  fontconfig      lib32-fontconfig
  mesa            lib32-mesa
  libxcursor      lib32-libxcursor
  libxrandr       lib32-libxrandr
  libxdamage      lib32-libxdamage
  libxi           lib32-libxi
  gettext         lib32-gettext
  desktop-file-utils
)
makedepends=(autoconf ncurses bison perl fontforge flex prelink
  'gcc>=4.5.0-2'  'gcc-multilib>=4.5.0-2'
  giflib          lib32-giflib
  libpng          lib32-libpng
  gnutls          lib32-gnutls
  libxinerama     lib32-libxinerama
  libxcomposite   lib32-libxcomposite
  libxmu          lib32-libxmu
  libxxf86vm      lib32-libxxf86vm
  libxml2         lib32-libxml2
  libldap         lib32-libldap
  lcms            lib32-lcms
  mpg123          lib32-mpg123
  openal          lib32-openal
  v4l-utils       lib32-v4l-utils
  alsa-lib        lib32-alsa-lib
  mesa            lib32-mesa
  mesa-libgl      lib32-mesa-libgl
)

optdepends=(
  giflib          lib32-giflib
  libpng          lib32-libpng
  libldap         lib32-libldap
  gnutls          lib32-gnutls
  lcms            lib32-lcms
  libxml2         lib32-libxml2
  mpg123          lib32-mpg123
openal            lib32-openal
  v4l-utils       lib32-v4l-utils
  libpulse        lib32-libpulse
  alsa-plugins    lib32-alsa-plugins
  alsa-lib        lib32-alsa-lib
  oss             cups
  samba
)


if [[ $CARCH == i686 ]]; then
  # Strip lib32 etc. on i686
  depends=(${depends[@]/*32-*/})
  makedepends=(${makedepends[@]/*32-*/})
  makedepends=(${makedepends[@]/*-multilib*/})
  optdepends=(${optdepends[@]/*32-*/})
  provides=("wine=$pkgver")
  conflicts=(wine)
else
  provides=("wine=$pkgver" "bin32-wine=$pkgver" "wine-wow64=$pkgver")
  conflicts=('wine' 'bin32-wine' 'wine-wow64')
  replaces=('wine' 'bin32-wine')
fi
build() {
  # Patching
  cd "$srcdir/$_pkgname-$_pkgbasever"

  # up fps
  msg2 "Applying patches for fps improvements..."
patch -p1 < $startdir/0001-wined3d-Don-t-mess-with-the-device-in-buffer_create_.patch 
patch -p1 < $startdir/0002-wined3d-Don-t-mess-with-the-device-in-buffer_get_sys.patch 
patch -p1 < $startdir/0003-wined3d-Pass-the-context-to-the-main-buffer-preload-.patch 
patch -p1 < $startdir/0004-wined3d-Move-the-decoded-stream-info-into-the-contex.patch 
patch -p1 < $startdir/0005-wined3d-Explicitly-pass-the-state-information-to-buf.patch 
patch -p1 < $startdir/0006-wined3d-Pass-the-context-to-the-internal-texture_pre.patch 
patch -p1 < $startdir/0007-wined3d-Pass-the-context-to-surface_internal_preload.patch 
patch -p1 < $startdir/0008-wined3d-Move-tex_unit_map-and-friends-into-the-conte.patch 
patch -p1 < $startdir/0009-wined3d-Move-device_preload_textures-into-context.c.patch 
patch -p1 < $startdir/0010-wined3d-Move-the-framebuffer-into-wined3d_state.patch 
patch -p1 < $startdir/0011-wined3d-Get-rid-of-state-access-in-shader_generate_g.patch 
patch -p1 < $startdir/0012-wined3d-Store-the-instance-count-in-the-context-stru.patch 
patch -p1 < $startdir/0013-wined3d-Preload-buffers-if-streamsrc-is-not-dirty.patch 
patch -p1 < $startdir/0014-wined3d-Introduce-a-command-stream.patch 
patch -p1 < $startdir/0015-wined3d-Wait-for-resource-updates-to-finish-when-usi.patch 
patch -p1 < $startdir/0016-Implement-cs_ops.-This-doesn-t-do-anything-on-its-ow.patch 
patch -p1 < $startdir/0017-wined3d-Send-present-calls-through-the-command-strea.patch 
patch -p1 < $startdir/0018-wined3d-Send-clears-through-the-command-stream.patch 
patch -p1 < $startdir/0019-wined3d-Don-t-store-pointers-in-struct-wined3d_cs_pr.patch 
patch -p1 < $startdir/0020-wined3d-Don-t-put-rectangle-pointers-into-wined3d_cs.patch 
patch -p1 < $startdir/0021-wined3d-Store-the-color-in-clear-ops-instead-of-a-po.patch 
patch -p1 < $startdir/0022-wined3d-Send-draws-through-the-command-stream.patch 
patch -p1 < $startdir/0023-wined3d-Pass-the-state-to-draw_primitive.patch 
patch -p1 < $startdir/0024-wined3d-Wait-for-the-cs-before-destroying-objects.patch 
patch -p1 < $startdir/0025-wined3d-Give-the-cs-its-own-state.patch 
patch -p1 < $startdir/0026-wined3d-Send-render-target-binding-updates-through-t.patch 
patch -p1 < $startdir/0027-wined3d-Send-float-constant-updates-through-the-comm.patch 
patch -p1 < $startdir/0028-wined3d-Properly-reset-the-command-streams-state.patch 
patch -p1 < $startdir/0029-wined3d-Request-a-glFinish-before-modifying-resource.patch 
patch -p1 < $startdir/0030-wined3d-Finish-the-cs-before-changing-the-texture-lo.patch 
patch -p1 < $startdir/0031-wined3d-Don-t-call-glFinish-after-clears.patch 
patch -p1 < $startdir/0032-wined3d-Don-t-call-glFinish-after-draws.patch 
patch -p1 < $startdir/0033-wined3d-Shadow-device-offscreenBuffer-in-the-context.patch 
patch -p1 < $startdir/0034-wined3d-Don-t-access-the-stateblock-in-find_draw_buf.patch 
patch -p1 < $startdir/0035-wined3d-Pass-the-depth-stencil-to-swapchain-present.patch 
patch -p1 < $startdir/0036-wined3d-Send-viewport-updates-through-the-command-st.patch 
patch -p1 < $startdir/0037-wined3d-Send-scissor-rect-updates-through-the-comman.patch 
patch -p1 < $startdir/0038-wined3d-Initialize-the-depth-stencil-with-the-proper.patch 
patch -p1 < $startdir/0039-wined3d-Set-depth-stencil-binding-updates-through-th.patch 
patch -p1 < $startdir/0040-wined3d-Keep-track-of-the-onscreen-depth-stencil-in-.patch 
patch -p1 < $startdir/0041-wined3d-Send-vertex-declaration-updates-through-the-.patch 
patch -p1 < $startdir/0042-wined3d-Send-vertex-buffer-binding-updates-through-t.patch 
patch -p1 < $startdir/0043-wined3d-Send-stream-frequency-updates-through-the-co.patch 
patch -p1 < $startdir/0044-wined3d-Send-index-buffer-binding-updates-through-th.patch 
patch -p1 < $startdir/0045-wined3d-Send-texture-binding-updates-through-the-com.patch 
patch -p1 < $startdir/0046-wined3d-Send-vertex-shader-binding-updates-through-t.patch 
patch -p1 < $startdir/0047-wined3d-Send-pixel-shader-binding-updates-through-th.patch 
patch -p1 < $startdir/0048-wined3d-Send-render-state-updates-through-the-comman.patch 
patch -p1 < $startdir/0049-wined3d-Send-texture-stage-state-updates-through-the.patch 
patch -p1 < $startdir/0050-wined3d-Send-sampler-state-updates-through-the-comma.patch 
patch -p1 < $startdir/0051-wined3d-Send-transformation-matrix-updates-through-t.patch 
patch -p1 < $startdir/0052-wined3d-Send-clip-plane-updates-through-the-command-.patch 
patch -p1 < $startdir/0053-wined3d-Send-material-updates-through-the-command-st.patch 
patch -p1 < $startdir/0054-wined3d-Send-base-vertex-index-updates-through-the-c.patch 
patch -p1 < $startdir/0055-wined3d-Send-primitive-type-updates-through-the-comm.patch 
patch -p1 < $startdir/0056-wined3d-Send-bool-constant-updates-through-the-comma.patch 
patch -p1 < $startdir/0057-wined3d-Send-int-constant-updates-through-the-comman.patch 
patch -p1 < $startdir/0058-wined3d-Send-constant-buffer-updates-through-the-com.patch 
patch -p1 < $startdir/0059-wined3d-Send-sampler-updates-through-the-command-str.patch 
patch -p1 < $startdir/0060-wined3d-Send-geometry-shader-updates-through-the-com.patch 
patch -p1 < $startdir/0061-wined3d-Send-stream-output-updates-through-the-comma.patch 
patch -p1 < $startdir/0062-wined3d-Send-light-updates-through-the-command-strea.patch 
patch -p1 < $startdir/0063-wined3d-Prevent-the-command-stream-from-running-ahea.patch 
patch -p1 < $startdir/0064-wined3d-Wait-for-the-cs-to-finish-before-destroying-.patch 
patch -p1 < $startdir/0065-wined3d-Run-the-cs-asynchronously.patch 
patch -p1 < $startdir/0066-wined3d-Send-blits-through-the-command-stream.patch 
patch -p1 < $startdir/0067-wined3d-Get-rid-of-WINED3D_BUFFER_FLUSH.patch 
patch -p1 < $startdir/0068-wined3d-Add-cs-waiting-debug-code.patch 
patch -p1 < $startdir/0069-wined3d-Don-t-force-strict-draw-ordering-for-multith.patch 
patch -p1 < $startdir/0070-wined3d-Send-color-fills-through-the-command-stream.patch 
patch -p1 < $startdir/0071-wined3d-Send-surface-maps-through-the-command-stream.patch 
patch -p1 < $startdir/0072-wined3d-Use-the-internal-map-function-in-surface_cpu.patch 
patch -p1 < $startdir/0073-wined3d-Get-rid-of-the-end_scene-flush-and-finish.patch 
patch -p1 < $startdir/0074-wined3d-Replace-the-linked-lists-with-a-ringbuffer.patch 
patch -p1 < $startdir/0075-wined3d-Don-t-preload-buffers-on-unmap.patch 
patch -p1 < $startdir/0076-wined3d-Use-double-buffered-buffers-for-multithreade.patch 
patch -p1 < $startdir/0077-wined3d-Don-t-synchronize-NOOVERWRITE-buffer-maps.patch 
patch -p1 < $startdir/0078-wined3d-Don-t-call-glFinish-before-swapping.patch 
patch -p1 < $startdir/0079-wined3d-Separate-buffer-map-write-and-draw-read-memo.patch 
patch -p1 < $startdir/0080-wined3d-Accelerate-DISCARD-buffer-maps.patch 
patch -p1 < $startdir/0081-wined3d-Accelerate-READONLY-buffer-maps.patch 
patch -p1 < $startdir/0082-wined3d-Access-the-buffer-dirty-areas-through-the-CS.patch 
patch -p1 < $startdir/0083-wined3d-wined3d_-_query_issue-never-fails.patch 
patch -p1 < $startdir/0084-wined3d-Add-query-support-to-the-command-stream.patch 
patch -p1 < $startdir/0085-wined3d-Check-our-CS-state-to-find-out-if-a-query-is.patch 
patch -p1 < $startdir/0086-wined3d-Introduce-a-separate-queue-for-priority-comm.patch 
patch -p1 < $startdir/0087-wined3d-Use-the-priority-queue-to-retrieve-query-dat.patch 
patch -p1 < $startdir/0088-wined3d-Poll-queries-automatically-in-the-CS.patch 
patch -p1 < $startdir/0089-wined3d-Destroy-queries-through-the-CS.patch 
patch -p1 < $startdir/0090-wined3d-Remove-another-glFinish.patch 
patch -p1 < $startdir/0091-wined3d-Ignore-buffer-resource.map_count-in-the-CS.patch 
patch -p1 < $startdir/0092-wined3d-Add-a-debug-FIXME-to-catch-cs-finish-calls.patch 
patch -p1 < $startdir/0093-wined3d-Send-buffer-preloads-through-the-CS.patch 
patch -p1 < $startdir/0094-winex11-complain-if-glFlush-or-glFinish-are-called.patch 
patch -p1 < $startdir/0095-wined3d-Use-glBufferSubData-instead-of-glMapBufferRa.patch 
patch -p1 < $startdir/0096-wined3d-Separate-main-and-worker-thread-query-state.patch 
patch -p1 < $startdir/0097-wined3d-Don-t-poll-queries-that-failed-to-start.patch 
patch -p1 < $startdir/0098-wined3d-Remove-restated-queries-from-the-poll-list.patch 
patch -p1 < $startdir/0099-wined3d-Control-WINED3D_BUFFER_DISCARD-from-the-work.patch 
patch -p1 < $startdir/0100-wined3d-Destroy-vertex-declarations-through-the-CS.patch 
patch -p1 < $startdir/0101-wined3d-Destroy-shaders-through-the-CS.patch 
patch -p1 < $startdir/0102-wined3d-CS-debug-message-cleanup.patch 
patch -p1 < $startdir/0103-wined3d-Send-update_surface-commands-through-the-CS.patch 
patch -p1 < $startdir/0104-wined3d-Send-texture-preloads-through-the-CS.patch 
patch -p1 < $startdir/0105-wined3d-Send-surface-preloads-through-the-CS.patch 
patch -p1 < $startdir/0106-wined3d-Send-update_texture-calls-through-the-CS.patch 
patch -p1 < $startdir/0107-wined3d-Get-rid-of-the-surface_upload_data-glFinish.patch 
patch -p1 < $startdir/0108-wined3d-Don-t-reset-the-query-state-if-it-doesn-t-ha.patch 
patch -p1 < $startdir/0109-wined3d-Handle-evit_managed_resources-through-the-CS.patch 
patch -p1 < $startdir/0110-wined3d-Send-flips-through-the-command-stream.patch 
patch -p1 < $startdir/0111-wined3d-Create-buffers-before-mapping-them.patch 
patch -p1 < $startdir/0112-wined3d-Don-t-lock-the-src-volume-in-device_update_v.patch 
patch -p1 < $startdir/0113-wined3d-Use-finer-grained-buffer-fencing.patch 
patch -p1 < $startdir/0114-wined3d-Fence-update_texture-calls.patch 
patch -p1 < $startdir/0115-wined3d-Put-this-into-the-query-poll-patch.patch 
patch -p1 < $startdir/0116-wined3d-Dirtify-volumes-on-unmap.patch 
patch -p1 < $startdir/0117-wined3d-Wrap-GL-BOs-in-a-structure.patch 
patch -p1 < $startdir/0118-wined3d-Separate-volume-map-and-draw-buffers.patch 
patch -p1 < $startdir/0119-wined3d-Move-buffer-creation-and-destruction-into-th.patch 
patch -p1 < $startdir/0120-wined3d-Request-volume-sysmem-loads-through-the-CS.patch 
patch -p1 < $startdir/0121-wined3d-Map-volume-BOs-through-the-CS.patch 
patch -p1 < $startdir/0122-wined3d-Send-volume-dirtifications-through-the-CS.patch 
patch -p1 < $startdir/0123-wined3d-Fence-the-destination-texture-in-update_text.patch 
patch -p1 < $startdir/0124-wined3d-Fence-texture-reads-in-draws.patch 
patch -p1 < $startdir/0125-wined3d-Don-t-wait-for-the-CS-when-mapping-volumes.patch 
patch -p1 < $startdir/0126-wined3d-Don-t-synchronize-DISCARD-maps.patch 
patch -p1 < $startdir/0127-wined3d-Put-update_surface-checks-back-in-place.patch 
  ./tools/make_requests
  cd "$srcdir"
  # Allow ccache to work
  mv $_pkgname-$_pkgbasever $_pkgname
  # Get rid of old build dirs
  rm -rf $_pkgname-{32,64}-build
  mkdir $_pkgname-32-build
  # These additional CFLAGS solve FS#27662
  export CFLAGS="${CFLAGS/-D_FORTIFY_SOURCE=2/} -D_FORTIFY_SOURCE=0"
  export CXXFLAGS="${CFLAGS/-D_FORTIFY_SOURCE=2/} -D_FORTIFY_SOURCE=0"
  if [[ $CARCH == x86_64 ]]; then
        msg2 "Building Wine-64..."
        mkdir $_pkgname-64-build
        cd "$srcdir/$_pkgname-64-build"
        ../$_pkgname/configure \
          --prefix=/usr \
          --sysconfdir=/etc \
          --libdir=/usr/lib \
          --with-x \
          --enable-win64
        make
        _wine32opts=(
          --libdir=/usr/lib32
          --with-wine64="$srcdir/$_pkgname-64-build"
        )
        export PKG_CONFIG_PATH="/usr/lib32/pkgconfig"
  fi
  msg2 "Building Wine-32..."
  cd "$srcdir/$_pkgname-32-build"
  ../$_pkgname/configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --with-x \
        "${_wine32opts[@]}"
  # These additional CFLAGS solve FS#27560
  make CFLAGS+="-mstackrealign" CXXFLAGS+="-mstackrealign"
}
package() {
  msg2 "Packaging Wine-32..."
  cd "$srcdir/$_pkgname-32-build"
  if [[ $CARCH == i686 ]]; then
        make prefix="$pkgdir/usr" install
  else
        make prefix="$pkgdir/usr" \
          libdir="$pkgdir/usr/lib32" \
          dlldir="$pkgdir/usr/lib32/wine" install
        msg2 "Packaging Wine-64..."
        cd "$srcdir/$_pkgname-64-build"
        make prefix="$pkgdir/usr" \
          libdir="$pkgdir/usr/lib" \
          dlldir="$pkgdir/usr/lib/wine" install
  fi
}

pkgname=wine-d3dstream
pkgver=1.7.1
pkgrel=1
md5sums=(
        '3a3fae3e541ccaf1b891d89b5594ecc5'
)
